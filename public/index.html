<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠˆíŒ… ì‹œë®¬ë ˆì´í„°</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: white; margin: 0; overflow: hidden; }
    #login, #lobby, #game, #result { display: none; }
    #login { margin-top: 200px; }
    input, button { padding: 10px; font-size: 16px; margin: 5px; }

    /* ëŒ€ê¸°ë°© ìŠ¤íƒ€ì¼ */
    #slots { display: flex; justify-content: center; gap: 20px; margin: 30px; }
    .slot {
      width: 150px; height: 100px; border: 2px solid #fff; display: flex;
      align-items: center; justify-content: center; font-size: 18px;
      position: relative;
    }
    .ready { color: lime; position: absolute; bottom: 5px; font-size: 14px; }

    /* ê²Œì„ ìŠ¤íƒ€ì¼ */
    canvas { background: radial-gradient(circle, #333 0%, #000 80%); display: block; margin: 0 auto; }

    /* ì²´ë ¥ë°” */
    .hp-bar {
      height: 6px;
      background: gray;
      border: 1px solid black;
      margin-top: -20px;
    }

    /* ê²°ê³¼ */
    #leaderboard { margin: 40px auto; width: 300px; text-align: left; }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="login">
    <h1>ğŸ”« ìŠˆíŒ… ì‹œë®¬ë ˆì´í„°</h1>
    <input id="nickname" type="text" placeholder="ì•„ì´ë”” ì…ë ¥" />
    <button id="joinBtn">ëŒ€ê¸°ë°© ì…ì¥</button>
    <p id="loginMsg"></p>
  </div>

  <!-- ëŒ€ê¸°ë°© í™”ë©´ -->
  <div id="lobby">
    <h2>ëŒ€ê¸°ë°©</h2>
    <div id="slots">
      <div class="slot" id="slot1"></div>
      <div class="slot" id="slot2"></div>
      <div class="slot" id="slot3"></div>
      <div class="slot" id="slot4"></div>
    </div>
    <button id="readyBtn">ê²Œì„ ì¤€ë¹„</button>
    <button id="startBtn" style="display:none;">ê²Œì„ ì‹œì‘</button>
    <p id="lobbyMsg"></p>
  </div>

  <!-- ê²Œì„ í™”ë©´ -->
  <div id="game">
    <canvas id="gameCanvas" width="900" height="700"></canvas>
    <div id="timer" style="position:absolute; top:10px; left:50%; transform:translateX(-50%); font-size:24px;"></div>
  </div>

  <!-- ê²°ê³¼ í™”ë©´ -->
  <div id="result">
    <h2>ğŸ† ê²°ê³¼</h2>
    <div id="leaderboard"></div>
    <button id="restartBtn">ê²Œì„ ë‹¤ì‹œ í•˜ê¸°</button>
  </div>

  <script>
    const socket = new WebSocket("wss://side2.onrender.com");
    const loginDiv = document.getElementById("login");
    const lobbyDiv = document.getElementById("lobby");
    const gameDiv = document.getElementById("game");
    const resultDiv = document.getElementById("result");
    const msgLogin = document.getElementById("loginMsg");
    const msgLobby = document.getElementById("lobbyMsg");
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const timer = document.getElementById("timer");

    let nickname = "";
    let playerId = null;
    let players = {};
    let coins = [];
    let gameTime = 180;
    let countdown = 0;
    let myColor = "red";

    // ğŸ¯ ì ‘ì† ì²˜ë¦¬
    socket.onopen = () => {
      console.log("ì„œë²„ ì—°ê²° ì„±ê³µ");
      loginDiv.style.display = "block";
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      switch (data.type) {
        case "loginResult":
          if (data.success) {
            nickname = data.nickname;
            playerId = data.id;
            showLobby(data.room);
          } else {
            msgLogin.innerText = data.message;
          }
          break;
        case "lobbyUpdate":
          updateLobby(data.room);
          break;
        case "startGame":
          startGame(data);
          break;
        case "gameState":
          players = data.players;
          coins = data.coins;
          gameTime = data.time;
          break;
        case "gameOver":
          showResult(data.result);
          break;
      }
    };

    // ğŸ® ë¡œê·¸ì¸ ë²„íŠ¼
    document.getElementById("joinBtn").onclick = () => {
      const name = document.getElementById("nickname").value.trim();
      if (!name) return msgLogin.innerText = "ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”!";
      socket.send(JSON.stringify({ type: "joinLobby", nickname: name }));
    };

    // ğŸ  ëŒ€ê¸°ë°© ê°±ì‹ 
    function showLobby(room) {
      loginDiv.style.display = "none";
      lobbyDiv.style.display = "block";
      updateLobby(room);
    }

    function updateLobby(room) {
      const slots = [slot1, slot2, slot3, slot4];
      slots.forEach(s => { s.innerHTML = ""; });
      room.players.forEach((p, i) => {
        let color = p.color || "white";
        slots[i].innerHTML = `<b style="color:${color}">${p.nickname}</b>` +
          (p.ready ? `<div class='ready'>ì¤€ë¹„ì¤‘...</div>` : "");
      });
      document.getElementById("startBtn").style.display = room.isHost ? "inline-block" : "none";
    }

    // âš™ï¸ ì¤€ë¹„ & ì‹œì‘
    document.getElementById("readyBtn").onclick = () => {
      socket.send(JSON.stringify({ type: "toggleReady" }));
    };
    document.getElementById("startBtn").onclick = () => {
      socket.send(JSON.stringify({ type: "startGame" }));
    };

    // ğŸ§© ê²Œì„ ì‹œì‘
    function startGame(data) {
      lobbyDiv.style.display = "none";
      gameDiv.style.display = "block";
      myColor = data.color;
      coins = data.coins;
      players = data.players;
      gameLoop();
    }

    // ğŸ¨ ê²Œì„ ë£¨í”„
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // í•„ë“œ ê²½ê³„
      ctx.beginPath();
      ctx.arc(450, 350, 300, 0, Math.PI * 2);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // ì½”ì¸ í‘œì‹œ
      coins.forEach(c => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, 5, 0, Math.PI * 2);
        ctx.fillStyle = "gold";
        ctx.fill();
      });

      // í”Œë ˆì´ì–´ í‘œì‹œ
      Object.values(players).forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();

        // HP í‘œì‹œ
        for (let i = 0; i < p.hp; i++) {
          ctx.fillStyle = "lime";
          ctx.fillRect(p.x - 20 + i * 8, p.y - 25, 6, 5);
        }
      });

      // íƒ€ì´ë¨¸
      const m = Math.floor(gameTime / 60);
      const s = gameTime % 60;
      timer.innerText = `${m}:${s.toString().padStart(2, "0")}`;

      requestAnimationFrame(gameLoop);
    }

    // ğŸ§¾ ê²°ê³¼ì°½
    function showResult(result) {
      gameDiv.style.display = "none";
      resultDiv.style.display = "block";
      const lb = document.getElementById("leaderboard");
      lb.innerHTML = "";
      result.forEach((r, i) => {
        lb.innerHTML += `<p>${i + 1}ë“± - ${r.nickname} (${r.coins}ê°œ)</p>`;
      });
    }

    document.getElementById("restartBtn").onclick = () => {
      resultDiv.style.display = "none";
      loginDiv.style.display = "block";
    };
  </script>
</body>
</html>



